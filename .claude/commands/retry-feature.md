---
description: "Re-attempts a feature implementation with learned patterns"
allowed-tools: ["*"]
---

# Command: retry-feature

## Purpose
Re-implements a feature that has been reviewed and corrected, applying all learned patterns to create an improved version.

## Use Cases
1. After significant corrections were made to a feature
2. When new patterns have been learned that would improve the implementation
3. To test if the AI has successfully learned from corrections
4. When the initial implementation was rejected entirely

## Process

### 1. Feature Selection
```bash
# Accept feature ID as parameter
FEATURE_ID="$1"

# Verify feature exists in approved or in-review
if [[ -f "features/approved/${FEATURE_ID}-*.md" ]]; then
  FEATURE_FILE=$(ls features/approved/${FEATURE_ID}-*.md)
  PREVIOUS_STATE="approved"
elif [[ -f "features/in-review/${FEATURE_ID}-*.md" ]]; then
  FEATURE_FILE=$(ls features/in-review/${FEATURE_ID}-*.md)
  PREVIOUS_STATE="in-review"
else
  echo "Error: Feature ${FEATURE_ID} not found"
  exit 1
fi
```

### 2. Learning Analysis
Before re-attempting, analyze what was learned:

1. Load correction report from `.ai-work/corrections/${FEATURE_ID}-corrections.md`
2. Identify all patterns that should be applied
3. Load current confidence levels for each pattern
4. Create a checklist of improvements to make

### 3. Preparation
```bash
# Create new branch from main
git checkout main
git pull origin main
git checkout -b ai/${FEATURE_ID}-retry-$(date +%Y%m%d-%H%M%S)

# Document retry context
```

Create `.ai-work/sessions/[timestamp]/retry-context.md`:
```markdown
# Retry Context: [Feature Name]

## Previous Implementation
- PR: #[number]
- Corrections Made: [count]
- Key Issues: [list main problems]

## Patterns to Apply
### High Confidence (>0.8)
- [Pattern 1]
- [Pattern 2]

### Medium Confidence (0.6-0.8)
- [Pattern 3]
- [Pattern 4]

## Specific Improvements
Based on previous corrections:
1. [Specific thing to fix]
2. [Another specific improvement]
```

### 4. Re-implementation Strategy

#### For Full Rewrite:
- Remove all previous implementation
- Re-implement from scratch following patterns
- Apply all learned corrections proactively

#### For Partial Update:
- Keep parts that were approved
- Rewrite only the corrected sections
- Apply patterns to new code only

### 5. Enhanced PRP Generation
Generate new PRP with learning section:

```markdown
# PRP: [Feature Name] (Retry)

## Learning Applied
This is a retry implementation incorporating learned patterns:

### Patterns Being Applied:
- âœ“ Use single quotes for imports (confidence: 0.9)
- âœ“ Arrow functions for components (confidence: 0.85)
- âœ“ Extract complex conditionals (confidence: 0.8)

### Previous Issues to Avoid:
- âœ— Don't use nested ternaries
- âœ— Avoid inline styles
- âœ— Don't skip error handling

[Rest of standard PRP content...]
```

### 6. Implementation with Verification
During implementation:
- Add comments showing where patterns were applied
- Run validation after each component
- Self-check against correction list

Example commit messages:
```bash
git commit -m "feat(${FEATURE}): reimplemented with learned patterns

ðŸ¤– AI Generated (Retry)
Applied patterns:
- Single quotes for imports
- Arrow function components
- Extracted complex logic

Previous PR: #${PREVIOUS_PR}
Session: ${SESSION_ID}

Co-Authored-By: Claude <noreply@anthropic.com>"
```

### 7. Comparison Report
Generate before creating PR:

```markdown
# Implementation Comparison: [Feature Name]

## Improvements Made
| Aspect | Previous | New | Pattern Applied |
|--------|----------|-----|-----------------|
| Import style | Double quotes | Single quotes | âœ“ |
| Component definition | Function declaration | Arrow function | âœ“ |
| Error handling | Missing | Comprehensive | âœ“ |

## Code Examples
### Before:
```javascript
import React from "react"
function Component() { ... }
```

### After:
```javascript
import React from 'react'
const Component = () => { ... }
```

## Confidence Score
Based on patterns applied: 85%
```

### 8. Create Improved PR
```bash
gh pr create --title "feat: ${FEATURE_NAME} (improved retry)" --body "$(cat <<'EOF'
## ðŸ¤– Retry Implementation

This is an improved implementation incorporating learned patterns.

### Previous PR: #${PREVIOUS_PR}

### Improvements Applied:
${IMPROVEMENT_LIST}

### Patterns Used:
${PATTERN_LIST}

### Testing:
- [ ] All previous corrections applied
- [ ] New patterns followed
- [ ] Tests pass
- [ ] Linting clean

### Comparison:
See detailed comparison in: .ai-work/sessions/${SESSION}/comparison.md

---
Generated by Claude AI (Retry)
This implementation should require fewer corrections
EOF
)"
```

### 9. Move Feature Status
- If from approved: stays in approved (new version)
- If from in-review: stays in in-review
- Add retry attempt to feature metadata

## Success Metrics
Track retry success rate:
- Corrections in original: X
- Corrections in retry: Y
- Improvement rate: ((X-Y)/X) * 100%

## Example Usage
```bash
claude /retry-feature --id=001
```

Output:
```
ðŸ”„ Retrying feature 001-user-authentication
ðŸ“š Loading 8 learned patterns...
ðŸŽ¯ Applying corrections from previous review...
ðŸ”¨ Re-implementing with improvements...
  âœ“ Applied single quote pattern (12 instances)
  âœ“ Converted to arrow functions (5 components)
  âœ“ Extracted complex logic (3 functions)
ðŸ“Š Improvement rate: 85% fewer issues expected
ðŸ“¤ Creating improved PR #31
âœ… Retry complete!
```

## Important Notes
- Always load and apply ALL relevant learned patterns
- Document which patterns were applied in commits
- Create clear comparison with previous implementation
- Track success metrics to measure learning effectiveness
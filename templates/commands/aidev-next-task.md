---
description: "Picks the next task from queue and implements it"
allowed-tools: ["*"]
---

# Command: aidev-next-task

## Purpose
Automatically picks the next task from the feature queue, generates a PRP, executes it, and creates a pull request for review.

## Process

### 1. Task Selection
- Look in `.aidev/features/queue/` for the lowest numbered task
- Move selected task to `.aidev/features/in-progress/`
- Read the task specification completely

### 2. Context Loading
- **Check .aidev/examples/** for coding style and patterns
- Load established patterns from `.aidev/patterns/established/`
- Load learned patterns from `.aidev/patterns/learned/`
- Read recent sessions from `.aidev/sessions/` for context
- Analyze existing codebase for similar implementations

### 3. Behavior Mode Detection

#### Pattern Establishment Mode (type: "pattern")
When the task is a pattern file (000-pattern-*.md):
- Create minimal, exemplar implementation
- Focus on establishing conventions
- Keep it simple but complete
- Include comments explaining choices
- Aim for 50-100 lines

#### Feature Implementation Mode (type: "feature")
When implementing a full feature:
- Follow all established patterns religiously
- Implement complete functionality
- Include proper error handling
- Add comprehensive types
- Write production-ready code

### 4. Git Setup
Configure git for AI attribution:
```bash
git config user.name "Claude AI"
git config user.email "claude@anthropic.com"
```

Create feature branch:
```bash
git checkout -b ai/[task-id]-[task-name]
# Example: ai/001-user-authentication
```

### 5. PRP Generation
Generate a PRP using `./.aidev/templates/automated-prp-template.md` with the following context:
- Feature specification from the selected task
- Learned patterns from `.aidev/patterns/learned/`
- Established patterns from `.aidev/patterns/established/`
- Previous corrections to avoid
- Session context from recent sessions

The template includes placeholders for:
- ${FEATURE_OVERVIEW}, ${TASK_ID}, ${TASK_NAME}, etc.
- ${ESTABLISHED_PATTERNS}, ${LEARNED_PATTERNS}
- ${SESSION_CONTEXT}, ${EXAMPLE_REFERENCES}
- Implementation mode detection (pattern vs feature)

Save the generated PRP to:
```
.aidev/sessions/[timestamp]/[task-id]-prp.md
```

### 6. Implementation
Execute the PRP with these requirements:
- Make atomic commits at logical boundaries
- Each commit should have meaningful AI attribution:
  ```
  feat(auth): implement user registration flow

  🤖 AI Generated
  Task: 001-user-authentication
  Session: 2025-01-07-001
  PRP: .aidev/sessions/2025-01-07-001/001-prp.md

  Co-Authored-By: Claude <noreply@anthropic.com>
  ```
- Run validation after each major component
- Document decisions in session log

### 7. Session Documentation
Create session log at `.aidev/sessions/[timestamp]/log.md`:
```markdown
# Session: 2025-01-07-001
## Task: 001-user-authentication

### Decisions Made
1. Chose to use NextAuth for consistency with existing patterns
2. Implemented Redis session storage for scalability

### Patterns Applied
- Component structure from 000-pattern-component
- API response format from 000-pattern-api

### Issues Encountered
- None

### Next Steps
- Awaiting human review
- Potential improvements identified: add rate limiting
```

### 8. Pull Request Creation
Create PR with comprehensive description:
```bash
gh pr create --title "feat: [task-name]" --body "$(cat <<'EOF'
## 🤖 AI Generated Implementation

### Task
[Task ID and name]

### Summary
[What was implemented]

### Changes
- [List of key changes]
- [Components created/modified]
- [Tests added]

### Patterns Followed
- [List patterns from established/learned]

### Testing
- [ ] All tests pass
- [ ] Linting clean
- [ ] Build successful

### Session
- Session ID: [timestamp]
- PRP: [path to PRP]
- Commits: [number of commits]

---
Generated by Claude AI
Review corrections will be captured for learning
EOF
)"
```

### 9. Finalization
- Move task from `.aidev/features/in-progress/` to `.aidev/features/in-review/`
- Update task file with PR number
- Create summary of what was implemented

## Error Handling
If any step fails:
1. Document the error in session log
2. Rollback to clean state
3. Move task back to queue with error notes
4. Report clear error message

## Example Usage
```bash
claude /aidev-next-task
```

Output:
```
🤖 Starting next task...
📋 Selected: 001-user-authentication
🔍 Loading patterns and context...
📝 Generating PRP...
🔨 Implementing feature...
  ✓ Created components
  ✓ Added API routes
  ✓ Set up authentication
  ✓ All tests passing
📤 Creating PR #23
✅ Task complete! PR ready for review.
```

## Important Notes
- Always follow established patterns exactly
- Make frequent, small commits
- Document why decisions were made
- Include comprehensive error handling
- Ensure all validation passes before PR creation